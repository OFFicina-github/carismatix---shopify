{%- liquid
  assign variant = product.selected_or_first_available_variant
  assign product_collection_handles = product.collections | map: 'handle'
  assign item_activities = product.metafields.custom.activities.value | join: ', '
  assign item_meteo = product.metafields.custom.meteo.value | join: ', '
  assign item_tech = product.metafields.custom.tech_features.value | join: ', '

  for option in product.options_with_values
    if option.name == 'Size' or option.name == 'Taglia'
      assign size_option = option
      assign size_option_key = 'option' | append: option.position
    endif
    if option.name == 'Color' or option.name == 'Colore'
      assign color_option = option
      assign color_option_key = 'option' | append: option.position
    endif
  endfor
  if color_option
    assign item_color = variant[color_option_key]
  endif
  assign size_availability = ''
  assign size_instock = 0
  assign size_all = 0
  if size_option
    assign item_size = variant[size_option_key]
    for pv in product.variants
      if pv[color_option_key] == item_color
        if pv.available
          assign size_availability = size_availability | append: pv[size_option_key] | append: ','
          assign size_instock = size_instock | plus: 1
        endif
        assign size_all = size_all | plus: 1
      endif
    endfor
  endif
%}

{%- for link in linklists['filtri-collections'].links -%}
  {%- if product_collection_handles contains link.object.handle -%}
    {% assign category = link.object.handle %}
    {%- for link2 in link.links -%}
      {%- if product_collection_handles contains link2.object.handle -%}
        {% assign category2 = link2.object.handle %}
        {%- for link3 in link2.links -%}
          {%- if product_collection_handles contains link3.object.handle -%}
            {% assign category3 = link3.object.handle %}
          {%- endif -%}
        {%- endfor -%}
        {% break %}
      {%- endif -%}
    {%- endfor -%}
    {% break %}
  {%- endif -%}
{%- endfor -%}

{% if variant.price != variant.compare_at_price %}
  {% assign on_sale = true %}
  {% assign discount_value = variant.compare_at_price | minus: variant.price %}
  {% assign discount_percentage = variant.compare_at_price
    | minus: variant.price
    | times: 100.0
    | divided_by: variant.compare_at_price
    | round: 2
  %}
{% endif %}
{ item_id: "{{ variant.sku }}",
item_name: "{{ product.title }}",
discount:{{ discount_value | default: 0 | divided_by: 100 }},
percentage_discount: {{ discount_percentage | default: 0 }},
item_season: "{{ product.metafields.custom.season }}",
size_instock: "{{ size_instock }}/{{ size_all }}",
size_availability: "{{ size_availability }}",
index: {{ index | default: 0 }},
item_brand: "SLAM", item_category: "{{- category -}}",
item_category2: "{{ category2 }}",
item_category3: "{{ category3 }}",
item_variant: "color: {{ item_color }}, size: {{ item_size }}",
item_color: "{{ item_color }}",
item_size: "{{ item_size }}",
item_meteo: "{{ item_meteo }}",
item_activities: "{{ item_activities }}", item_tech: "{{ item_tech }}",
item_impermeabile:{{ product.metafields.custom.waterproof | default: 0 }},
item_protezione_uv:{{ product.metafields.custom.uv-protection | default: 0 }},
item_traspirante:{{ product.metafields.custom.breathable | default: 0 }},
item_antivento:{{ product.metafields.custom.windproof | default: 0 }},
price: {{ variant.price | default: 0 | divided_by: 100 }},
currency: "{{ shop.currency }}"
}
