{% liquid
  assign current_language = request.locale.iso_code

  case current_language
    when 'it'
      assign lang = 'it'
      assign cookie_policy_number = '49699792'

    when 'en'
      assign lang = 'en-GB'
      assign cookie_policy_number = '64401869'

    when 'fr'
      assign lang = 'fr'
      assign cookie_policy_number = '59444835'

    when 'es'
      assign lang = 'es'
      assign cookie_policy_number = '19357778'

    when 'de'
      assign lang = 'de'
      assign cookie_policy_number = '99005899'

    else
      assign lang = 'en-GB'
      assign cookie_policy_number = '64401869'
  endcase
%}

<script type="text/javascript">
  var _iub = _iub || [];
  _iub.csConfiguration = {
    "countryDetection": true,
    "consentOnContinuedBrowsing": false,
    "perPurposeConsent": true,
    "lang": "{{ lang }}",
    "siteId": 3549422,
    "cookiePolicyId": {{ cookie_policy_number }},
    "banner": {
      "acceptButtonDisplay": true,
      "customizeButtonDisplay": true,
      "rejectButtonDisplay": true,
      "position": "float-top-center",
      "acceptButtonColor":"#2F978F"
    }
  };

  var onPreferenceFirstExpressedCallback = function(consent) {
    var shopifyPurposes = {
      "analytics": [4, 's'],
      "marketing": [5, 'adv'],
      "preferences": [2, 3],
      "sale_of_data": ['s', 'sh'],
    };
    var expressedConsent = {};
    Object.keys(shopifyPurposes).forEach(function(purposeItem) {
      var purposeExpressed = null;
      shopifyPurposes[purposeItem].forEach(item => {
        if (consent.purposes && typeof consent.purposes[item] === 'boolean') {
          purposeExpressed = consent.purposes[item];
        }
        if (consent.uspr && typeof consent.uspr[item] === 'boolean' && purposeExpressed !== false) {
          purposeExpressed = consent.uspr[item];
        }
      });
      
      if (typeof purposeExpressed === 'boolean') {
        expressedConsent[purposeItem] = purposeExpressed;
      }
    });

    expressedConsent['analytics'] = true;
    expressedConsent['marketing'] = true;
    window.Shopify.customerPrivacy.setTrackingConsent(expressedConsent, function() {});
    
    // Pushing 'cookie_iubenda' event to the dataLayer
    if (typeof dataLayer !== 'undefined') {
      dataLayer.push({
        event: "cookie_iubenda"
      });

      // Pushing 'cookie_vai' event to the dataLayer after 1 second
      setTimeout(function() {
        dataLayer.push({
          event: "cookie_vai"
        });
      }, 1000); // 1000 milliseconds = 1 second
    }
  };

  var onReadyCookie = function(){
    window.Shopify.customerPrivacy.setTrackingConsent({
      'analytics': true,
      'marketing': true
    }, function() {});
  }

  if (typeof _iub.csConfiguration.callback === 'object') {
    _iub.csConfiguration.callback.onPreferenceFirstExpressed = onPreferenceFirstExpressedCallback;
    _iub.csConfiguration.callback.onReady = onReadyCookie;
  } else {
    _iub.csConfiguration.callback = {
      onPreferenceFirstExpressed: onPreferenceFirstExpressedCallback,
      onReady: onReadyCookie
    };
  }
</script>

<script type="text/javascript" src="//cdn.iubenda.com/cs/iubenda_cs.js" charset="UTF-8" async></script>

<script type="text/javascript">
  window.Shopify.loadFeatures(
    [
      {
        name: 'consent-tracking-api',
        version: '0.1',
      },
    ],
    function(error) {
      if (error) {
        throw error;
      }
    }
  );
</script>
